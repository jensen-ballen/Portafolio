@page "/"
@inject IJSRuntime JSRuntime
@inject PortfolioSecurityService SecurityService
@inject HttpClient HttpClient

<PageTitle>Portfolio Viewer - Jensen Ballen</PageTitle>

<div class="portfolio-viewer">
    <header class="viewer-header">
        <h1>🛡️ Portfolio Viewer Seguro</h1>
        <p>Visualización protegida del portafolio de Jensen Ballen</p>
    </header>

    <div class="viewer-controls">
        <button @onclick="LoadPortfolio" class="btn-load">
            📂 Cargar Portafolio
        </button>
        <button @onclick="ToggleSecurity" class="btn-security">
            🔒 @(showSecurity ? "Ocultar" : "Mostrar") Seguridad
        </button>
    </div>

    @if (showSecurity)
    {
        <div class="security-panel">
                <h3>Estado de Seguridad</h3>
                <div class="security-status">
                    <div class="status-item">
                        <span class="status-icon">🔐</span>
                        <span>Encriptación Base64: Activa</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">🌐</span>
                        <span>Acceso Multiplataforma: Habilitado</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">🛡️</span>
                        <span>Sandboxing Seguro: Activo</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">📱</span>
                        <span>Compatible con Todos los Browsers</span>
                    </div>
                </div>
            </div>
    }

    <div class="portfolio-content" id="portfolioContainer">
        @if (isLoading)
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando portafolio seguro...</p>
            </div>
        }
        else if (portfolioLoaded)
        {
            <div class="portfolio-display">
                @if (!string.IsNullOrEmpty(portfolioHtml))
                {
                    <div class="portfolio-iframe-container">
                        <iframe srcdoc="@portfolioHtml"
                                class="portfolio-iframe"
                                sandbox="allow-scripts allow-same-origin allow-forms"
                                title="Portafolio Seguro">
                        </iframe>
                    </div>
                }
                <div class="security-notice">
                    <div class="notice-icon">🔒</div>
                    <div class="notice-text">
                        <h4>Portafolio Protegido</h4>
                        <p>Este portafolio incluye múltiples capas de seguridad:</p>
                        <ul>
                            <li>Encriptación Base64 para compatibilidad universal</li>
                            <li>Acceso multiplataforma (Windows, macOS, Linux, móviles)</li>
                            <li>Sandboxing seguro con CSP y headers de seguridad</li>
                            <li>Compatible con todos los navegadores modernos</li>
                            <li>Arquitectura C#/.NET para mayor robustez</li>
                        </ul>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .portfolio-viewer {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .viewer-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .viewer-header h1 {
        color: #2563eb;
        margin-bottom: 0.5rem;
    }

    .viewer-controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }

    .btn-load, .btn-security {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    .btn-load {
        background: linear-gradient(135deg, #2563eb, #1d4ed8);
        color: white;
    }

    .btn-load:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-security {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
    }

    .btn-security:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }

    .security-panel {
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
        border: 1px solid #cbd5e1;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .security-panel h3 {
        margin-bottom: 1rem;
        color: #1e293b;
        text-align: center;
    }

    .security-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .status-icon {
        font-size: 1.5rem;
    }

    .portfolio-content {
        min-height: 200px;
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8fafc;
    }

    .portfolio-display {
        width: 100%;
        max-width: 1200px;
    }

    .portfolio-iframe-container {
        width: 100%;
        height: 600px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .portfolio-iframe {
        width: 100%;
        height: 100%;
        border: none;
        background: white;
    }

    .security-notice {
        display: flex;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border: 1px solid #0ea5e9;
        border-radius: 12px;
        align-items: flex-start;
    }

    .notice-icon {
        font-size: 2rem;
        flex-shrink: 0;
    }

    .notice-text h4 {
        margin: 0 0 0.5rem 0;
        color: #0c4a6e;
        font-size: 1.2rem;
    }

    .notice-text p {
        margin: 0 0 1rem 0;
        color: #0369a1;
        font-weight: 500;
    }

    .notice-text ul {
        margin: 0;
        padding-left: 1.5rem;
        color: #075985;
    }

    .notice-text li {
        margin-bottom: 0.25rem;
    }

    .loading {
        text-align: center;
        color: #64748b;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #2563eb;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .success-message {
        color: #059669;
        font-weight: 600;
        text-align: center;
        padding: 2rem;
    }
</style>

@code {
    private bool showSecurity = false;
    private bool isLoading = false;
    private bool portfolioLoaded = false;
    private string portfolioHtml = string.Empty;
    private Dictionary<string, string> securityStatus = new();

    protected override void OnInitialized()
    {
        securityStatus = SecurityService.GetSecurityStatus();
    }

    private async Task LoadPortfolio()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Cargar el HTML del portafolio desde los archivos incluidos en wwwroot
            portfolioHtml = await HttpClient.GetStringAsync("portfolio/index.html");

            // Agregar estilos y scripts de seguridad adicionales
            portfolioHtml = await EnhancePortfolioSecurity(portfolioHtml);

            portfolioLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading portfolio: {ex.Message}");
            portfolioHtml = $"<div style='color: red; text-align: center; padding: 2rem;'>Error al cargar el portafolio: {ex.Message}</div>";
            portfolioLoaded = true;
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task<string> EnhancePortfolioSecurity(string html)
    {
        // Agregar headers de seguridad adicionales
        var securityHeaders = @"
        <meta http-equiv='Content-Security-Policy' content='default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self''>
        <meta name='referrer' content='no-referrer'>
        <meta name='robots' content='noindex, nofollow'>
        <base href='./portfolio/'>
        ";

        // Insertar headers de seguridad después del tag <head>
        html = html.Replace("<head>", "<head>" + securityHeaders);

        // Corregir rutas de archivos para que funcionen desde el subdirectorio
        html = html.Replace("src=\"security.min.js\"", "src=\"portfolio/security.min.js\"");
        html = html.Replace("src=\"Img/", "src=\"portfolio/Img/");
        html = html.Replace("href=\"idioma/translations.js\"", "href=\"portfolio/idioma/translations.js\"");

        // Encriptar datos sensibles usando el servicio C#
        html = await EncryptSensitiveDataInHtml(html);

        return html;
    }

    private async Task<string> EncryptSensitiveDataInHtml(string html)
    {
        // Aquí podríamos extraer y encriptar datos sensibles del HTML
        // usando el servicio de seguridad de C# en lugar del JavaScript

        // Por ahora, mantenemos la funcionalidad existente pero aseguramos
        // que las rutas sean correctas
        return html;
    }

    private void ToggleSecurity()
    {
        showSecurity = !showSecurity;
    }
}
