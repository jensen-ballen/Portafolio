@page "/"
@inject IJSRuntime JSRuntime
@inject PortfolioSecurityService SecurityService
@inject HttpClient HttpClient

<PageTitle>Portfolio Viewer - Jensen Ballen</PageTitle>

<div class="portfolio-viewer">
    <!-- Botón de cambio de tema -->
    <button @onclick="ToggleTheme" class="theme-toggle-btn" title="Cambiar tema">
        <span class="theme-icon sun"></span>
        <span class="theme-icon moon"></span>
    </button>

    <header class="viewer-header">
        <h1>🛡️ Portfolio Viewer Seguro</h1>
        <p>Visualización protegida del portafolio de Jensen Ballen</p>
    </header>

    <div class="viewer-controls">
        <button @onclick="LoadPortfolio" class="btn-load">
            📂 Cargar Portafolio
        </button>
        <button @onclick="ToggleSecurity" class="btn-security">
            🔒 @(showSecurity ? "Ocultar" : "Mostrar") Seguridad
        </button>
    </div>

    @if (showSecurity)
    {
        <div class="security-panel">
                <h3>Estado de Seguridad</h3>
                <div class="security-status">
                    <div class="status-item">
                        <span class="status-icon">🔐</span>
                        <span>Encriptación Base64: Activa</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">🌐</span>
                        <span>Acceso Multiplataforma: Habilitado</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">🛡️</span>
                        <span>Sandboxing Seguro: Activo</span>
                    </div>
                    <div class="status-item">
                        <span class="status-icon">📱</span>
                        <span>Compatible con Todos los Browsers</span>
                    </div>
                </div>
            </div>
    }

    <div class="portfolio-content" id="portfolioContainer">
        @if (isLoading)
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>Cargando portafolio seguro...</p>
            </div>
        }
        else if (portfolioLoaded)
        {
            <div class="portfolio-display">
                @if (!string.IsNullOrEmpty(portfolioHtml))
                {
                    <div class="portfolio-iframe-container">
                        <iframe srcdoc="@portfolioHtml"
                                class="portfolio-iframe"
                                sandbox="allow-scripts allow-same-origin allow-forms"
                                title="Portafolio Seguro">
                        </iframe>
                    </div>
                }
                <div class="security-notice">
                    <div class="notice-icon">🔒</div>
                    <div class="notice-text">
                        <h4>Portafolio Protegido</h4>
                        <p>Este portafolio incluye múltiples capas de seguridad:</p>
                        <ul>
                            <li>Encriptación Base64 para compatibilidad universal</li>
                            <li>Acceso multiplataforma (Windows, macOS, Linux, móviles)</li>
                            <li>Sandboxing seguro con CSP y headers de seguridad</li>
                            <li>Compatible con todos los navegadores modernos</li>
                            <li>Arquitectura C#/.NET para mayor robustez</li>
                        </ul>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<link rel="stylesheet" href="css/portfolio-viewer.css" />

@code {
    private bool showSecurity = false;
    private bool isLoading = false;
    private bool portfolioLoaded = false;
    private string portfolioHtml = string.Empty;
    private Dictionary<string, string> securityStatus = new();
    private string currentTheme = "light";

    protected override async Task OnInitializedAsync()
    {
        securityStatus = SecurityService.GetSecurityStatus();

        // Cargar tema guardado
        currentTheme = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "portfolio-theme") ?? "light";
        await ApplyTheme(currentTheme);
    }

    private async Task LoadPortfolio()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Cargar el HTML del portafolio desde los archivos incluidos en wwwroot
            portfolioHtml = await HttpClient.GetStringAsync("portfolio/index.html");

            // Agregar estilos y scripts de seguridad adicionales
            portfolioHtml = await EnhancePortfolioSecurity(portfolioHtml);

            portfolioLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading portfolio: {ex.Message}");
            portfolioHtml = $"<div style='color: red; text-align: center; padding: 2rem;'>Error al cargar el portafolio: {ex.Message}</div>";
            portfolioLoaded = true;
        }

        isLoading = false;
        StateHasChanged();
    }

    private async Task<string> EnhancePortfolioSecurity(string html)
    {
        // Agregar headers de seguridad adicionales
        var securityHeaders = @"
        <meta http-equiv='Content-Security-Policy' content='default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self''>
        <meta name='referrer' content='no-referrer'>
        <meta name='robots' content='noindex, nofollow'>
        <base href='./portfolio/'>
        ";

        // Insertar headers de seguridad después del tag <head>
        html = html.Replace("<head>", "<head>" + securityHeaders);

        // Corregir rutas de archivos para que funcionen desde el subdirectorio
        html = html.Replace("src=\"security.min.js\"", "src=\"portfolio/security.min.js\"");
        html = html.Replace("src=\"Img/", "src=\"portfolio/Img/");
        html = html.Replace("href=\"idioma/translations.js\"", "href=\"portfolio/idioma/translations.js\"");

        // Encriptar datos sensibles usando el servicio C#
        html = await EncryptSensitiveDataInHtml(html);

        return html;
    }

    private async Task<string> EncryptSensitiveDataInHtml(string html)
    {
        // Aquí podríamos extraer y encriptar datos sensibles del HTML
        // usando el servicio de seguridad de C# en lugar del JavaScript

        // Por ahora, mantenemos la funcionalidad existente pero aseguramos
        // que las rutas sean correctas
        return html;
    }

    private void ToggleSecurity()
    {
        showSecurity = !showSecurity;
    }

    private async Task ToggleTheme()
    {
        currentTheme = currentTheme == "light" ? "dark" : "light";
        await ApplyTheme(currentTheme);
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "portfolio-theme", currentTheme);
    }

    private async Task ApplyTheme(string theme)
    {
        await JSRuntime.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-theme', '{theme}')");
        StateHasChanged();
    }
}
